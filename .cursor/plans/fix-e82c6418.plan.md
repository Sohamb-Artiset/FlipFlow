<!-- e82c6418-a44c-4529-8e83-b918803c46b9 dd277ca2-d180-4c47-97a5-ce717822a13f -->
# Fix flipbook views with RLS + single RPC (based on tablesnow.sql)

### What I found in tablesnow.sql

- Tables exist for `flipbooks`, `flipbook_views`, `profiles`, `user_roles`.
- The "Name/Command/Applied" lines are comments only; RLS isn’t actually enabled and no policies are created yet.
- `flipbook_views.ip_address` is `text` (not `inet`). We’ll keep `text` to match.

### Decision

- Record analytics on view (not on upload). Insert into `flipbook_views` when a flipbook is viewed and increment `flipbooks.view_count` atomically.

### 1) Database changes: enable RLS, align existing policies, add RPC

Your DB already has policies (per pg_policies). We’ll adjust only what’s needed and keep the rest.

Key fixes:

- Explicitly enable RLS on all affected tables (pg_policies doesn’t show RLS state).
- Replace any use of role "public" in policies with explicit `anon, authenticated` where appropriate.
- Tighten `flipbook_views` insert policy so anon inserts are only for public flipbooks; owners can insert for their private ones.
- Add a single RPC to atomically insert a view and increment count.
```sql
-- Ensure gen_random_uuid is available
create extension if not exists pgcrypto;

-- Explicitly enable RLS (idempotent if already on)
alter table public.flipbooks enable row level security;
alter table public.flipbook_views enable row level security;
alter table public.profiles enable row level security;
alter table public.user_roles enable row level security;

-- flipbooks: keep owner/public policies; ensure roles are anon/authenticated for public reads
create policy if not exists flipbooks_select_owner
  on public.flipbooks for select to authenticated
  using (user_id = auth.uid());
create policy if not exists flipbooks_select_public
  on public.flipbooks for select to anon, authenticated
  using (coalesce(is_public, false) = true);
create policy if not exists flipbooks_insert_owner
  on public.flipbooks for insert to authenticated
  with check (user_id = auth.uid());
create policy if not exists flipbooks_update_owner
  on public.flipbooks for update to authenticated
  using (user_id = auth.uid())
  with check (user_id = auth.uid());
create policy if not exists flipbooks_delete_owner
  on public.flipbooks for delete to authenticated
  using (user_id = auth.uid());

-- flipbook_views: restrict anon inserts to public flipbooks; allow owner inserts; owner can select
drop policy if exists "Anyone can insert views" on public.flipbook_views;
create policy if not exists flipbook_views_insert_public
  on public.flipbook_views for insert to anon, authenticated
  with check (
    exists (
      select 1 from public.flipbooks f
      where f.id = flipbook_id and coalesce(f.is_public, false) = true
    )
  );
create policy if not exists flipbook_views_insert_owner
  on public.flipbook_views for insert to authenticated
  with check (
    exists (
      select 1 from public.flipbooks f
      where f.id = flipbook_id and f.user_id = auth.uid()
    )
  );
drop policy if exists "Owners can view analytics" on public.flipbook_views;
create policy if not exists flipbook_views_select_owner
  on public.flipbook_views for select to authenticated
  using (
    exists (
      select 1 from public.flipbooks f
      where f.id = flipbook_id and f.user_id = auth.uid()
    )
  );

-- profiles: self-only (your policies align; ensuring explicit roles)
create policy if not exists profiles_select_self
  on public.profiles for select to authenticated
  using (id = auth.uid());
create policy if not exists profiles_insert_self
  on public.profiles for insert to authenticated
  with check (id = auth.uid());
create policy if not exists profiles_update_self
  on public.profiles for update to authenticated
  using (id = auth.uid())
  with check (id = auth.uid());

-- user_roles: self select + admin manage
create or replace function public.has_role(_role public.app_role, _user_id uuid)
returns boolean language sql stable as $
  select exists (
    select 1 from public.user_roles r
    where r.user_id = _user_id and r.role = _role
  );
$;
create policy if not exists user_roles_select_self
  on public.user_roles for select to authenticated
  using (user_id = auth.uid());
create policy if not exists user_roles_all_admin
  on public.user_roles for all to authenticated
  using (public.has_role('admin', auth.uid()))
  with check (public.has_role('admin', auth.uid()));

-- Atomic RPC to record view and increment count
create or replace function public.record_flipbook_view(
  p_flipbook_id uuid,
  p_user_agent text default null,
  p_ip text default null
) returns void
language plpgsql security definer set search_path = public as $
begin
  if not exists (
    select 1 from public.flipbooks f
    where f.id = p_flipbook_id
      and (coalesce(f.is_public, false) = true or f.user_id = auth.uid())
  ) then
    raise exception 'not allowed';
  end if;

  update public.flipbooks
  set view_count = coalesce(view_count, 0) + 1
  where id = p_flipbook_id;

  insert into public.flipbook_views (flipbook_id, user_agent, ip_address)
  values (p_flipbook_id, p_user_agent, p_ip);
end;$;
```


### 2) App changes: use the single RPC

- In `src/pages/FlipbookView.tsx` and `src/hooks/useFlipbookAnalytics.ts`, replace the two calls (RPC + direct insert) with:
```ts
await supabase.rpc('record_flipbook_view', {
  p_flipbook_id: flipbookId,
  p_user_agent: navigator.userAgent,
});
```

- Remove usage of `increment_view_count` RPC (not defined in DB).

### 3) Keep upload logic unchanged

- No analytics write on upload (`src/components/FlipbookUpload.tsx` remains as-is).

### 4) Repo cleanups

- Remove `dist/` (build output) and `bun.lockb` (you’re using npm via `package-lock.json`).

### 5) Verify

- Anonymous viewing of a public flipbook creates a `flipbook_views` row and increments `view_count`.
- Owner can query their `flipbook_views` via app analytics.
- Private flipbooks only count views for the owner.

### To-dos

- [ ] Add table, RLS policies, and record_flipbook_view RPC
- [ ] Switch to single RPC call in view tracking
- [ ] Remove dist/ and bun.lockb from repo
- [ ] Test public/owner/private view flows create records